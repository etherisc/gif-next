= Architecture

NOTE: This document is under construction

== Introduction

=== Decentralized Insurance Protocol (DIP)

The Decentralized Insurance Protocol (DIP) enables the creation and management of decentralized insurance products. The protocol is designed to be flexible and extensible, allowing for the creation of a wide range of insurance products. 

The protocol supports a multi-chain ecosystem to let users choose the chain that best fits their needs. The protocol is designed to be chain agnostic, allowing for the deployment of the protocol on any EVM compatible chain.

=== Generalized Insurance Framework (GIF)

The Generalized Insurance Framework (GIF) is a set of smart contracts that implement the Decentralized Insurance Protocol (DIP). 
The main Goal of the GIF is to support its users in creating and managing decentralized insurance products as efficitiently and safe as possible. 

GIF users should be able to focus on their use case specific business logic.
GIF takes care of the use case independent heavy lifting like managing policies, claims, payouts, managing collateral in pools, etc.

The GIF itself is a highly modularized and flexible infrastructure that can be deployed to any EVM compatible chain.
Most contracts of the GIF will already be deployed and are ready to be used by the users.

== Multi-Chain Setup

=== Overview

For each supported chain a chain specific GIF setup is deployed.
To link all chains together a global registry is deployed on mainnet.
This global registry then holds the links to all chain specific registries as shown in the diagram below.

image::./images/multi-chain-setup.png[Multi-chain setup]

=== Global Registry

The global registry is deployed on mainnet can be understood as the directory and entry point for the complete protocol ecosystem. 

The global registry contains entries for all protocol relevant objects on mainnet and a chain registry entry for each supported chain in the ecosystem.
At the same time the global registy plays the role of the mainnet chain registry.

=== Chain Registries

On each chain supported by the protocol a chain registry is deployed.
A chain registry contains entries for all protocol relevant objects on that specific chain.
These entries hold basic metadata of the object and are backed by an NFT that defines the ownership of the object.

The list below provides the basic metadata for each object in the registry:

* NFT ID: A protocol unique ID
* Parent NFT ID: A pointer to the parent object in the registry
* Object Type: The type of the object (registry, service, instance, product, policy, etc)
* Object Address: The contract address for contract objects

=== Protocol Objects

The following objects are managed by the protocol:

[cols="1,3"]
|===
|Object |Comments

|Protocol |The object representing the protocol itself
|Registry |Registry contracts
|Instance |Instance contracts linked to the chain registry
|Product |Product contracts linked to an instance
|Policy |Policy object linked to a product contract
|Distribution |Distribution contracts linked to an instance
|Distributor |Distributor object linked to a distribution contract
|Oracle |Oracle contracts linked to an instance
|Pool |Pool contracts linked to an instance
|Bundle |Bundle object linked to a pool contract
|Staking |Staking contracts linked to the chain registry
|Stake |Stake object linked to its target object (instance or protocol)
|===


== Single-Chain Setup

=== Overview

The GIF setup on any specific chain always consists of a registry and staking modules, services and instances as shown in the diagram below.

image::./images/single-chain-setup.png[Single-chain setup]

=== Registry

Registries have already been introduced in the text above.
As already mentioned a registry is the central entry point for all protocol objects on a specific chain.

=== Staking

The staking module is used to manage the DIP that are staked by users to either the protocol itself or to an instance that is registered as a staking target.

=== Instance

Instances are used by ecosystem participants to create and operate actual use cases/products.
Instances consist of a set of instance contracts and a number of so-called components that are required to implement an actual use cases. 

=== Components

Currently, products, distributions, oracles, and pools as supported by GIF as component types.

=== Services

Services are used to implement the generic insurance business logic of the GIF.
Components, instances, the registry and the staking module may only interact with each other through these generic service contracts.

A set of consistent service contracts define the functionality of a GIF release.
Even though the service contracts are upgradeable, only non breaking changes are ever allowed inside a specific major release.
For simplicity the above diagram only shows the setup for a single major release.

== Modules and Services

=== Overview

=== Modules

Modules are defined as a set of contracts that serve a specific purpose.
Each contract in a module has its clear role and responsibility and interacts with other contracts in the module to fulfill its purpose.
Contracts in the same module may directly interact with each other without the need to go over a service contract.

Examples of modules are the registry module, the staking module, and instance modules.

=== Services

Services contracts implement the GIF business logic that operates on the state of module contracts.
Service contract may also interact with other service contracts.

In general, services do not have any state that is not fixed at deployment/registration time.
The only exception being the instance service that holds the addresses of the so called master instance which is used to clone new instances.

=== Registry Module

image::./images/registry-module.png[Registry Module]

=== Staking Module

image::./images/staking-module.png[Staking Module]

- Keep track of total value locked (TVL) per instance
- TVL: amount of tokens locked by active policies
- Creating policies increase TVL, executing payouts and closing policies decrease TVL
- TVL in USD may be calculated using price feeds or CEX/DEX exchange rates
- Staking will initially be supported on instance level (bundle staking too fine grained)
- A corresponding amount of DIP token shall be staked using a staking rate
- For the tracking of TVL and related DIP stakes a global dashboard will be provided

== Authorization

=== Overview

Autorization is a key concept in the GIF.
Authorization is organized per supported chain and implemented in access admin contracts using role based access control.

=== Access Admin

Access admin contracts manage explicit lists of named targets, roles and functions that are granted to these roles.
It also provides view functions that allow to enumerate all available roles, current role members and all granted functions for every managed target.

The implementation of the access admin contract is based on OpenZeppelin's `AccessManagerUpgradeable` and `AccessManagedUpgradeable` contracts.

The access admin contract extends the OpenZeppelin functionality by providing named roles, targets and functions and by providing the capability to enumerate all current role members and all granted functions for every managed target.

The access admin contract is the base contract for two specialized admin contracts.
Per supported chain there is a registry admin contract and for each instance there is an instance admin contract.

=== Registry Admin

The registry admin contract is the central contract that controls access to the registry, to staking as well as interactions between service contracts.

In the case of services the registry admin maintains access to service functions per major release in the sense that a service of a specific major release may only interact with services of the same major release.

=== Instance Admin

For each instance an individual instance admin contract exits.
This instance admin is used to manage authorizations for the interactions between the instance and all its linked components with all linked services.

=== Upgrading Contracts

Authorization for upgrading upgradeable contracts is a special case.
Every upgradeable contract in GIF comes with its own proxy manager contract.
Only this proxy manager contract may be used to upgrade an upgradeable contract.
And only the owner of an upgradeable contract may execute an upgrade via this proxy manager contract.

The ownership of an GIF relevant upgradeable contract is defined via its NFT as recorded in the chain registry.

Upgradeability relies on OpenZeppelin's `TransparentUpgradeableProxy` and `ProxyAdmin` contracts.

== Release Management

=== Overview
GIF releases follow semantic versioning, which includes major, minor, and patch releases. 
The major version number is incremented whenever there are breaking changes that could potentially disrupt existing functionality or compatibility.

For every major releases, a consistent set of upgradeable service contracts are deployed and registered with the registry. 
For non-breaking changes the existing service contracts are upgraded in place.
The staking module is independently upgradeable and may be upgraded at any time.
The registry module is non-upgradeable and is capable of serving multiple major releases simultaneously.
Instance modules are non-upgradeable and directly linked to the service contracts of the same major release.

Adding a new major release is guarded by role based authorization including two roles, a GIF Admin role and the GIF Manager role.

=== Initial Chain Deployment

An initial chain deployment deploys the registry contracts and the staking contracts.


=== Release Deployment


== Instances

=== Overview

=== Instance Module

- Instance contracts are non upgradable
- Instance contracts support minor and patch updates of services
- Instance contracts do not support major updates of services
- New instances are created by the instancer owner calling `InstanceService.createInstance`
- Transactional operations (writing) are only via services
- Read access to the instance is done through the `InstanceReader` and/or services
- Every instance has its own `AuthorizationManager` for managing authorizations
- Authorization is managed by the instance owner
- GIF provides default set of authorizations when cloning the instance
- Instances are not upgradable

=== Component Modules

- Components are built and deployed by the component owners (which are not the same as the protocol owner)
- Components interact with the instance through the services
- Components are bound to a fixed major version of a service
  Patch/Minor version upgrades of a service will be done by the protocol owner and will be completely transparent to the component owner
  Major version upgrades will require a new component version to be deployed by the component owner
- End users (consumers) interact with the system through components
- Components must provide all necessary functions for consumer interaction 
- Components use the instance's `AuthorizationManager` for authorization checks
